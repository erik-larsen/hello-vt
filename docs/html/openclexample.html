<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>LibVT: LibVT usage example for a single pass solution using MRT and OpenCL buffer reduction</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="OpenCLExample">LibVT usage example for a single pass solution using MRT and OpenCL buffer reduction </a></h1><div class="fragment"><pre class="fragment"> <span class="keyword">static</span> GLuint ct, dt, fbo, info;

 <span class="keywordtype">void</span> init() <span class="comment">// called at startup</span>
 {
        <a class="code" href="_lib_v_t_8h.html#a9927a78d7798699e3d951fa899fd26b7" title="Initializes LibVT and must be called previous to all other functions.">vtInit</a>(<span class="stringliteral">&quot;/Path/to/the/tile/dir/&quot;</span>, <span class="stringliteral">&quot;jpg&quot;</span>, 0, 8, 256); <span class="comment">// jpeg tiles, no border, mipchain length 8, and 256x256 tiles</span>

        <span class="keywordtype">char</span> *prelude = <a class="code" href="_lib_v_t_8h.html#ab95fd80fe3e91cb20e410f2238915eb7" title="Returns the shader prelude that must be prepended to the virtual texturing shaders...">vtGetShaderPrelude</a>();

        combined = loadShadersWithPrelude(<span class="stringliteral">&quot;combined&quot;</span>, prelude); <span class="comment">// use the combined shader for a single MRT pass</span>

        free(prelude);

        <a class="code" href="_lib_v_t_8h.html#a41a8053f6cfc5cf8f827f6b1f89b0efd" title="Prepares the OpenGL resources used by LibVT. It must be called after vtInit() and...">vtPrepare</a>(combined, combined); <span class="comment">// opengl must be ready when you call this</span>

        glGenTextures(1, &amp;info); <span class="comment">// create a texture that the tile determination buffer will be rendered into</span>
        <a class="code" href="_lib_v_t_8h.html#a33d7ec47ea314d0dd93fddb86de14813" title="Prepares the OpenCL resources used by LibVT. Must only be called if OPENCL_BUFFERREDUCTION...">vtPrepareOpenCL</a>(info); <span class="comment">// the opencl stuff needs to know this texture. we could pass 0 in a dual pass OpenCL solution where the FBO would still be managed by LibVT</span>
 
        renderViewHasBeenResizedOrFovChanged(640, 480, 90.0);
 }

 <span class="keywordtype">void</span> renderViewHasBeenResizedOrFovChanged(<span class="keywordtype">int</span> newW, <span class="keywordtype">int</span> newH, <span class="keywordtype">float</span> newFov) <span class="comment">// called at start and when w/h/fov change</span>
 {
        <span class="keywordtype">float</span> nearPlane = 1.0f, farPlane = 7000.0f;

        glEnable(GL_TEXTURE_RECTANGLE_ARB);
        
        <span class="keywordflow">if</span> (!ct) glGenTextures(1, &amp;ct);  <span class="comment">// create FBO to render into </span>
        glBindTexture(GL_TEXTURE_RECTANGLE_ARB, ct);
        glTexParameteri(GL_TEXTURE_RECTANGLE_ARB, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
        glTexParameteri(GL_TEXTURE_RECTANGLE_ARB, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
        glTexImage2D(GL_TEXTURE_RECTANGLE_ARB, 0, GL_RGBA, newW, newH, 0, GL_BGRA, GL_UNSIGNED_INT_8_8_8_8_REV, NULL);
        
        assert(info); <span class="comment">// we already created this and passed it to LibVT</span>
        glBindTexture(GL_TEXTURE_RECTANGLE_ARB, info);
        glTexParameteri(GL_TEXTURE_RECTANGLE_ARB, GL_TEXTURE_MAG_FILTER, GL_LINEAR);
        glTexParameteri(GL_TEXTURE_RECTANGLE_ARB, GL_TEXTURE_MIN_FILTER, GL_LINEAR);
        glTexImage2D(GL_TEXTURE_RECTANGLE_ARB, 0, GL_RGBA, newW, newH, 0, GL_BGRA, GL_UNSIGNED_INT_8_8_8_8_REV, NULL);
        
        <span class="keywordflow">if</span> (!dt) glGenTextures(1, &amp;dt);
        glBindTexture(GL_TEXTURE_RECTANGLE_ARB, dt);
        glTexParameteri(GL_TEXTURE_RECTANGLE_ARB, GL_TEXTURE_MAG_FILTER, GL_NEAREST);
        glTexParameteri(GL_TEXTURE_RECTANGLE_ARB, GL_TEXTURE_MIN_FILTER, GL_NEAREST);
        glTexParameteri(GL_TEXTURE_RECTANGLE_ARB, GL_DEPTH_TEXTURE_MODE, GL_LUMINANCE );
        glTexParameteri(GL_TEXTURE_RECTANGLE_ARB, GL_TEXTURE_COMPARE_MODE, GL_NONE );
        glTexImage2D(GL_TEXTURE_RECTANGLE_ARB, 0, GL_DEPTH_COMPONENT24, newW, newH, 0, GL_DEPTH_COMPONENT, GL_UNSIGNED_BYTE, NULL);
        
        <span class="keywordflow">if</span> (!fbo) glGenFramebuffersEXT(1, &amp;fbo);
        glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, fbo);
        
        glFramebufferTexture2DEXT(GL_FRAMEBUFFER_EXT, GL_COLOR_ATTACHMENT0_EXT, GL_TEXTURE_RECTANGLE_ARB, ct, 0);
        glFramebufferTexture2DEXT(GL_FRAMEBUFFER_EXT, GL_COLOR_ATTACHMENT1_EXT, GL_TEXTURE_RECTANGLE_ARB, info, 0);
        glFramebufferTexture2DEXT(GL_FRAMEBUFFER_EXT, GL_DEPTH_ATTACHMENT_EXT, GL_TEXTURE_RECTANGLE_ARB, dt, 0);
        
        <span class="keywordflow">if</span> (glCheckFramebufferStatusEXT(GL_FRAMEBUFFER_EXT) != GL_FRAMEBUFFER_COMPLETE_EXT)
                vt_fatal(<span class="stringliteral">&quot;Error: couldn&apos;t setup FBO %04x\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)glCheckFramebufferStatusEXT(GL_FRAMEBUFFER_EXT));
        
        glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, 0);
        
        glDisable(GL_TEXTURE_RECTANGLE_ARB);
        glBindTexture(GL_TEXTURE_RECTANGLE_ARB, 0);
        
        <a class="code" href="_lib_v_t_8h.html#a33a38c85152447cf555a7a905353204c" title="Sets up LibVT for usage with current rendering parameters. Must be called once at...">vtReshape</a>(newW, newH, newFov, nearPlane, farPlane);
 }

 <span class="keywordtype">void</span> render() <span class="comment">// called every frame</span>
 {
                glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, fbo); <span class="comment">// setup FBO to render into</span>
                glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
        
                GLenum mrt[] = { GL_COLOR_ATTACHMENT0_EXT, GL_COLOR_ATTACHMENT1_EXT}; <span class="comment">// yes we gonna do MRT, wohooo!</span>
                glDrawBuffers(2, mrt);
        
                <a class="code" href="_lib_v_t_8h.html#a1b5f0f43f71460c980ec9574ba90d0a2" title="Must be called every frame before rendering the virtual textured geometry for the...">vtMapNewPages</a>();
        
        
                glUseProgram(combined); <span class="comment">// need to use the proper shader</span>
                        glUniform1f(glGetUniformLocation(combined, <span class="stringliteral">&quot;mip_bias&quot;</span>), <a class="code" href="_lib_v_t_8h.html#af4e213c5d72893725a3490513b17c066" title="Provides the bias that should be used for the float bias for the uniform &amp;quot;mip_bias&amp;quot;...">vtGetBias</a>());

                        renderVirtualTexturedObjects();

                glUseProgram(0);
                glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, 0);
        
                <a class="code" href="_lib_v_t_8h.html#a72334d116fa08ca4f79d3bd30929ba22" title="Must be called to reduce the buffer when doing OpenCL integration, before vtExtractNeededPagesOpenCL...">vtPerformOpenCLBufferReduction</a>(); <span class="comment">// run the OpenCL kernel on the info texture</span>
                <a class="code" href="_lib_v_t_8h.html#a199d55105136637c714b2d63542537b8" title="Must be called to after buffer reduction when doing OpenCL integration, to extract...">vtExtractNeededPagesOpenCL</a>();  <span class="comment">// finish the kernel, read back the results and extract the needed pages from it, pass to to the loading threead</span>
        
        
                glBindFramebufferEXT(GL_READ_FRAMEBUFFER_EXT, fbo); <span class="comment">// blit from FBO to screen</span>
                glBindFramebufferEXT(GL_DRAW_FRAMEBUFFER_EXT, 0);
                glBlitFramebufferEXT(0, 0, vt.real_w, vt.real_h,
                               0, 0, vt.real_w, vt.real_h,
                               GL_COLOR_BUFFER_BIT,
                               GL_NEAREST);
                glBindFramebufferEXT(GL_READ_FRAMEBUFFER_EXT, 0);
                glBindFramebufferEXT(GL_DRAW_FRAMEBUFFER_EXT, 0);
                glBindFramebufferEXT(GL_FRAMEBUFFER_EXT, 0);

                renderSomeOtherObjects();
 }

 <span class="keywordtype">void</span> shutdown() <span class="comment">// called at shutdown</span>
 {
        <a class="code" href="_lib_v_t_8h.html#a6cdbd1da7fa7009e1ca22ec280e7e20f" title="Must be called before the program exits if multithreading is enabled.">vtShutdown</a>();
 }
</pre></div> </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on Sun Jun 20 23:49:20 2010 for LibVT by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
